<%= javascript_include_tag 'application' %>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<p style="color: green"><%= notice %></p>
<style>
  .button {
    background-color: #1c87c9;
    border: none;
    color: white;
    padding: 12px 27px;
    text-align: center;
    text-decoration: none;
    display: inline-block;
    font-size: 20px;
    margin: 4px 2px;
    cursor: pointer;
  }
  .btn-green{
    background-color: green;
  }
  .btn-red{
    background-color: red;
  }
</style>
<% if current_user==nil %>
  <a href="http://127.0.0.1:3000/users/sign_in" class="button">clicca qui per fare il login</a>
<% else %>
  <%= button_to "User", user_path(current_user.id), method: "get"%>
<% end %>

<h1>Posts</h1>

<%= link_to "New post", new_post_path %>


  
  <% @posts.each do |post| %>
    <%= render post %>
  <% end %>
</div>

<script>
  var max_id = $('#posts').data('max_id')
  $('.btn').on('click', function() {
    if($(this).hasClass('btn-green')){
      $(this).removeClass('btn-green')
      $('#'+String($(this).attr("id"))+'.like-count').text($('#'+String($(this).attr("id"))+'.like-count').text()-1)   
    }
    else if($(this).hasClass('btn-red')){
      $(this).removeClass('btn-red')
      $('#'+String($(this).attr("id"))+'.like-count').text(parseInt($('#'+String($(this).attr("id"))+'.like-count').text())+1)   
    }
    else if($(this).hasClass('like-btn') && !$(this).hasClass('btn-green')){
      if($('#'+String($(this).attr("id"))+'.dislike-btn').hasClass('btn-red')){
        $('#'+String($(this).attr("id"))+'.dislike-btn').removeClass('btn-red')
      $('#'+String($(this).attr("id"))+'.like-count').text(parseInt($('#'+String($(this).attr("id"))+'.like-count').text())+2)   
      }
      else{
      $('#'+String($(this).attr("id"))+'.like-count').text(parseInt($('#'+String($(this).attr("id"))+'.like-count').text())+1)   
      }  
      $(this).addClass('btn-green')
    }
    else if($(this).hasClass('dislike-btn') && !$(this).hasClass('btn-red')){
      if($('#'+String($(this).attr("id"))+'.like-btn').hasClass('btn-green')){
        $('#'+String($(this).attr("id"))+'.like-btn').removeClass('btn-green')
      $('#'+String($(this).attr("id"))+'.like-count').text(parseInt($('#'+String($(this).attr("id"))+'.like-count').text())-2)   
      }
      else{
      $('#'+String($(this).attr("id"))+'.like-count').text(parseInt($('#'+String($(this).attr("id"))+'.like-count').text())-1)   
      }
      $(this).addClass('btn-red')
    }
  });
  $(".comment-form").submit(function(event) {
    event.preventDefault();
    var post_id = $(this).data('post-id');
    var form = $(this);
    var formUrl = $(this).attr("action");
    var formData = $(this).serialize();
    var formDataArray = $(this).serializeArray();
    var username = $("#posts").attr("data-username");
    var user_id = $("#posts").attr("data-user_id");
    var body = formDataArray[1].value;
    $.ajax({
      url: formUrl,
      type: 'POST',
      data: formData,
      success: function(response) {
        if (form.prev().prev().hasClass("no-comment")){
          form.prev().prev().remove();
          form.prev().prev().after('<ul><li><a href="/users/'+user_id+'">' + username + '</a> - ' + body + ' - </li><button type="button" class="delete" data-p_id="'+post_id+'" data-id='+(max_id+1)+'>Delete</button></ul>');
        }
        else{
          form.prev().prev().append('<li><a href="/users/'+user_id+'">' + username + '</a> - ' + body + ' - </li><button type="button" class="delete" data-p_id="'+post_id+'" data-id='+(max_id+1)+'>Delete</button>');
        }
        form.find(".comment-text").val("");
        max_id+=1;
      },
      error: function(error) {
        alert('errore')
      }
    });
  });
  $(document).on('click', '.delete', function() {
    var button = $(this);
    var post_id = String($(this).data('p_id'));
    var comment_id =  String($(this).data('id'));
    var deleteUrl = "/posts/" + post_id + "/comments/" + comment_id;
    $.ajax({
      url: deleteUrl,
      type: 'DELETE',
      data: {
        authenticity_token: $('meta[name="csrf-token"]').attr('content'),
        post_id: post_id,
        id: comment_id
      },
      success: function(response) {
        button.prev().remove();
        button.remove();

      },
      error: function(error) {
        alert('errore')
      }
    });
  });
</script>