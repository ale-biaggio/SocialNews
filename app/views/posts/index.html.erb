<%= javascript_include_tag 'application' %>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<p style="color: green"><%= notice %></p>
<style>
  .button {
    background-color: #1c87c9;
    border: none;
    color: white;
    padding: 12px 27px;
    text-align: center;
    text-decoration: none;
    display: inline-block;
    font-size: 20px;
    margin: 4px 2px;
    cursor: pointer;
  }
  .btn-green{
    background-color: green;
  }
  .btn-red{
    background-color: red;
  }
</style>
<% if current_user==nil %>
  <a href="http://127.0.0.1:3000/users/sign_in" class="button">clicca qui per fare il login</a>
<% end %>
<h1>Posts</h1>

<div id="posts">
  <% i = 1 %>
  <% @posts.each do |post| %>
    <%= render post %>
    <% if user_signed_in? %>
     <% if post.liked?(current_user) %>
        <%= button_to "Up", like_post_path(post), class: 'btn like-btn btn-green', id:"#{i}" %> 
      <% else %>
        <%= button_to "Up", like_post_path(post), class: 'btn like-btn', id:"#{i}" %>
      <% end %>
       <span class="like-count" id="<%=i%>"><%= post.rank %></span>
      <% if post.disliked?(current_user) %>
        <%= button_to "Down", dislike_post_path(post), class: 'btn btn-red dislike-btn', id:"#{i}"  %>
      <% else %>
        <%= button_to "Down", dislike_post_path(post), class: 'btn dislike-btn', id: "#{i}" %>
      <% end %>
    <% else %>
      <a href="http://127.0.0.1:3000/users/sign_in"><%= button_to "Up" %></a>
       <%= post.rank %> 
      <a href="http://127.0.0.1:3000/users/sign_in"><%= button_to "Down" %></a>
    <% end %> 

    <h2> Comments: </h2>
    <% if post.comments.empty? %>
      <p>No comments for this post...</p>
    <% else %>
      <ul>
      <% post.comments.each do |r| %>
        <li> <%= User.find(r.user_id).username %> - <%= r.body %> - <%= r.like %> -

        <% if current_user!=nil and current_user.id == User.find(r.user_id).id %>
         <%= link_to 'Edit', edit_post_comment_path(r.post, r) %>
        <% end %>

        <% if can? :destroy , r or (current_user!=nil and current_user.id == User.find(r.user_id).id) %>
         <%= button_to 'Delete', [r.post, r], :method => :delete, data: { confirm: 'Are you sure?' } %>
        <% end %>

      <% end %>
      </ul>
    <% end %>

    <%= link_to "Add a comment", new_post_comment_path(post) %>

    <% if current_user!=nil and current_user.id == post.user_id%>
      <%= link_to "Edit this post", edit_post_path(post) %>
    <% end %>
    
    <%= if can? :destroy, post or (current_user!=nil and current_user.id == post.user_id) then button_to 'Delete post', post, method: :delete, data:{ confirm: 'Are you sure?' } end%>
  
    <hr>
    <% i += 1 %>
  <% end %>
</div>

<%= link_to "New post", new_post_path %>
<script>
  $('.btn').on('click', function() {
    if($(this).hasClass('btn-green')){
      $(this).removeClass('btn-green')
      $('#'+String($(this).attr("id"))+'.like-count').text($('#'+String($(this).attr("id"))+'.like-count').text()-1)   
    }
    else if($(this).hasClass('btn-red')){
      $(this).removeClass('btn-red')
      $('#'+String($(this).attr("id"))+'.like-count').text(parseInt($('#'+String($(this).attr("id"))+'.like-count').text())+1)   
    }
    else if($(this).hasClass('like-btn') && !$(this).hasClass('btn-green')){
      if($('#'+String($(this).attr("id"))+'.dislike-btn').hasClass('btn-red')){
        $('#'+String($(this).attr("id"))+'.dislike-btn').removeClass('btn-red')
      $('#'+String($(this).attr("id"))+'.like-count').text(parseInt($('#'+String($(this).attr("id"))+'.like-count').text())+2)   
      }
      else{
      $('#'+String($(this).attr("id"))+'.like-count').text(parseInt($('#'+String($(this).attr("id"))+'.like-count').text())+1)   
      }  
      $(this).addClass('btn-green')
    }
    else if($(this).hasClass('dislike-btn') && !$(this).hasClass('btn-red')){
      if($('#'+String($(this).attr("id"))+'.like-btn').hasClass('btn-green')){
        $('#'+String($(this).attr("id"))+'.like-btn').removeClass('btn-green')
      $('#'+String($(this).attr("id"))+'.like-count').text(parseInt($('#'+String($(this).attr("id"))+'.like-count').text())-2)   
      }
      else{
      $('#'+String($(this).attr("id"))+'.like-count').text(parseInt($('#'+String($(this).attr("id"))+'.like-count').text())-1)   
      }
      $(this).addClass('btn-red')
    }
  });
</script>
