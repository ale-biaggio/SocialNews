<% 
  max_id = Comment.maximum(:id)
  if max_id == nil
    max_id = 0
  end 
  post_id = post.id
%>

<div class='container' style="width: 60%; border-style: solid; border-color:black; border-radius:20px;">
  <br>
  <div class='container'>
    <div class='row'>
      <div class='col-11'>
        <h5><%= link_to post.user.name, user_path(post.user.id), method: "get"%></h5>
        <h5><%= link_to post.user.surname, user_path(post.user.id), method: "get"%></h5>
        <% if User.find(post.user.id).verified==1 %>
          <%= image_tag("verified-icon.png", style:"width: 15px; height: 15px;") %>
        <% end %>
      </div>
      <div class='col-1'>
        <% if user_signed_in? %>
            <div id="posts" data-name="<%= current_user.name %>" data-user_id="<%= current_user.id %>" data-max_id ="<%= max_id %>">
            <% if !post.favorited?(current_user) %>
          <button type="button" class="favorite" data-post_id="<%=post_id%>"><%= image_tag("empty-star.png", style:"width: 20px; height: 20px;", data: { empty_star_path: image_path('empty-star.png'), yellow_star_path: image_path('yellow-star.png')}) %></button>     
            <% else %>
          <button type="button" class="favorite" data-post_id="<%=post_id%>"><%= image_tag("yellow-star.png", style:"width: 20px; height: 20px;", data: { empty_star_path: image_path('empty-star.png'), yellow_star_path: image_path('yellow-star.png')}) %></button>     
            <% end %>
        <% else %>
          <div id="posts" data-max_id ="<%= max_id %>" data-post_id="<%= post.id %>">
        <% end %>
        </div>
          
      </div>
    </div>
  </div>
  <div class='col-12'>
    <p>
      <strong>#<%= post.category %></strong>
    </p>
  </div>
  <div class='col-12'>
    <p>
      <h5><%= post.title %></h5>
    </p>
  </div>
  <div class='container'>
    <div class='row'>
      <div class='col-4'>
        <%= image_tag post.image, :style => "width: 100%; border-radius: 5px;" if post.image.attached?%>
        <%= image_tag post.img_test, :style => "width: 100%; border-radius: 5px;" if post.img_test != nil%>
      </div>
      <div class='col-8'>
        <% if post.url != nil %>
          <p><%= post.body %>...<a href = "<%= post.url %>" target="_blank" rel="noopener noreferrer">articolo completo</a></p>
        <% else %>
          <p><%= post.body %></p>
        <% end %>
      </div>
    </div>
  </div>

  <br>

  <div class='container'>
    <div class='row'>
      <div class='col-3'>
          <% if user_signed_in? %>
            <div class='row'>
              <div class='col-4'>
                <% if post.liked?(current_user) %>
                  <%= button_to like_post_path(post), class: 'btn like-btn btn-green', id:post_id do %> 
                  <i class="fa-solid fa-caret-up fa-3x" style="color: gray;"></i>
                  <% end %>
                <% else %>
                  <%= button_to like_post_path(post), class: 'btn like-btn', id:post_id do %>
                  <i class="fa-solid fa-caret-up fa-3x" style="color: gray;"></i>
                  <% end %>
                <% end %>
              </div>
              <div class='col-4' style='text-align: center; display: contents;'>
                <span class="like-count" id="<%=post_id%>" style="padding-top: 20px;"><%= post.rank %></span>
              </div>
              <div class='col-4'>
                <% if post.disliked?(current_user) %>
                  <%= button_to dislike_post_path(post), class: 'btn btn-red dislike-btn', id:post_id do %>
                  <i class="fa-solid fa-caret-down fa-3x" style="color: gray;"></i>
                  <% end %>
                <% else %>
                  <%= button_to dislike_post_path(post), class: 'btn dislike-btn', id: post_id do%>
                  <i class="fa-solid fa-caret-down fa-3x" style="color: gray;"></i>
                  <% end %>
              </div>
            </div>
            <% end %>
          <% else %>
            <div class='row'>
              <div class='col-4'>
                  <i class="fa-solid fa-caret-up fa-3x" style="color: gray;"></i>
              </div>
              <div class='col-4'>
                <span class="like-count" id="<%=post_id%>" style="padding-top: 20px;"><%= post.rank %></span>
              </div>
              <div class='col-4'>
                  <i class="fa-solid fa-caret-down fa-3x" style="color: gray;"></i>
              </div>
            </div>
          <% end %> 
      </div>
      <div class='col-6'>
        <% if post.comments.empty? %>
          <p class="no-comment">No comments for this post...</p>
        <% else %>
          <ul class="comment-list">
          <% post.comments.each do |r| %>
            <% if r.visible %>
              <li> <a href="/users/<%=r.user_id%>"><%= User.find(r.user_id).name%> <%= User.find(r.user_id).surname %></a> - <%= r.body %> - <%= r.like %> </li>
              <% if can? :destroy , r or (current_user!=nil and current_user.id == User.find(r.user_id).id) %>
                <button type="button" class="delete" data-p_id="<%=r.post.id%>" data-id="<%=r.id%>">Delete</button>     
              <% end %>
            <% end %>
          <% end %>
          </ul>
        <% end %>
        <%= form_with model: [ post, @comment ], data: { post_id: post_id, max_id: max_id }, class: "comment-form" do |form| %>
          <% if @comment.errors.any? %>
            <div id="error_explanation">
              <h4><%= pluralize(@comment.errors.count, "error") %> prohibited this review from being saved:</h4>
              <ul>
                <% @comment.errors.each do |error| %>
                  <li><%= error.full_message %></li>
                <% end %>
              </ul>
            </div>
          <% end %>
          <div class="row">
            <div class="col-9">
              <div class="field" style="width:100%;">
                <%= form.text_area :body, class: "comment-text", placeholder: "Lascia un commento", style: "width: 100%; height:30px;" %>
              </div>
            </div>
            <div class="col-3">
              <% if user_signed_in? %>
                <div class="field">
                  <div style="display:none"> <%= form.select :user_id,[current_user.id] %> </div>
                </div>
                <div class="actions">
                  <%= form.submit "+", class: "comment-submit", style: "border-radius:20px;"%>
                </div>
              <% end %>
        <% end %>
        <% if current_user == nil %>
          <a href="http://127.0.0.1:3000/users/sign_in"><button style="border-radius:20px;">+</button></a><br>
        <% end %>  
        <% if current_user!=nil and current_user.id == post.user_id%>
          <%= link_to "Edit this post", edit_post_path(post) %>
        <% end %>
          </div>
        </div>
      </div>
      <div class='col-3'>
        
      </div>
    </div>

  <script type='text/javascript' src='https://platform-api.sharethis.com/js/sharethis.js#property=6410620c82a5320015aeb382&product=sop' async='async' ></script>
  <div class="sharethis-inline-share-buttons" data-url="<%= post.url %>"></div>

  <%= if can? :destroy, post or (current_user!=nil and current_user.id == post.user_id) then button_to 'Delete post', post, method: :delete, data:{ confirm: 'Are you sure?' } end%>
  </div>
</div>

<hr>

<script>
$(document).on('click', '.like-btn, .dislike-btn', function() {
  var $this = $(this);
  var post_id = $this.attr('id');
  var action = $this.attr('action');
  var method = $this.attr('method');
  var thumb_color = $this.find('i').css('color');

  $.ajax({
    url: action,
    type: method,
    data: { post_id: post_id },
    success: function(data) {
      var $like_count = $('#'+post_id+' .like-count');
      $like_count.text(data.rank);

      if ($this.hasClass('like-btn')) {
        if (thumb_color == 'rgb(0, 128, 0)') {
          $this.find('i').css('color', 'gray');
        } else {
          $this.find('i').css('color', 'green');
          $('.dislike-btn[id="'+post_id+'"]').find('i').css('color', 'gray');
        }
      } else {
        if (thumb_color == 'rgb(255, 0, 0)') {
          $this.find('i').css('color', 'gray');
        } else {
          $this.find('i').css('color', 'red');
          $('.like-btn[id="'+post_id+'"]').find('i').css('color', 'gray');
        }
      }
    }
  });

  return false;
});
</script>